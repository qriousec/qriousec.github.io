#!/bin/sh

if [ $# -ne 1 ]; then
    echo "Usage: $0 <path-to-exploit>"
    exit 1
fi

IMAGE="/home/kali/Documents/new_research_place/image"
BZIMAGE="/home/kali/Documents/new_research_place/kasan_instances/cos-109-17800.436.33/6d837756c3d0b3b617c83468d345146a191adfeb/arch/x86/boot/bzImage"
EXPLOIT="$1"

sudo mount -o loop $IMAGE/bullseye.img /mnt/cve
cp $1 /mnt/cve/home/longhh/exploit
sudo umount /mnt/cve

##########################

qemu-system-x86_64 \
        -m 2G \
        -smp 2 \
        -kernel $BZIMAGE \
        -append "console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0 nokaslr" \
        -drive file=$IMAGE/bullseye.img,format=raw \
        -net user,host=10.0.2.10,hostfwd=tcp:127.0.0.1:10021-:22 \
        -cpu kvm64,+smep,+smap \
        -net nic,model=e1000 \
        -enable-kvm \
        -nographic \
        -pidfile vm.pid \
	    -s \
	    -no-reboot \
        2>&1 | tee vm.log